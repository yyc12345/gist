# 开发帮助

BMERevenge是内置于BallanceBlenderPlugin内的一套路面生成器（原本之前打算做新的2D编辑器，后来放弃了，改为直接Blender内生成）

此文档是BMERevenge开发中遵守的一些规定

## Prototype

### 坐标系

* 坐标系系统使用Blender的右手坐标系
* UV系统使用右手坐标系，具体参考后图
* 原型中为了书写方便，使用四边形面，并且Blender也支持四边形面，可以直接写入。四边形面顶点序使用右手定则确定正面指向（OpenGL默认用右手坐标系，默认用右手定则确认正面；DirectX默认用左手坐标系，默认用左手定则确认正面）。原型中同时也使用三角形面，规定与四边形面一致
* 各个面的定义按方块左上角顶面位置为原点，以3D坐标系定义（不要使用Screen坐标系）（如果顶面左上角有下沉，则按未下沉的位置定义）
* 每种方块具有延伸方向的属性，对于Column模式的方块，其延伸方向即为延伸方向指定的方向，而对于Freedom模式的方块，由于是可以沿着两个方向进行延伸，则规定延伸方向指定的方向为第一延伸方向，第二延伸方向在第一方向顺时针旋转后的下一个方向
* 方块的Mesh内的旋转方向定义为Z轴的右手螺旋方向（+Z与右手螺旋指向一致，螺旋方向为旋转方向）

```
     +-----------------------------+
+V   |                             |
     | Image                       |
 ^   |                             |
 |   |                             |
 |   |                             |
 |   |                             |
 |   |                             |
 |   |                             |
 |   |                             |
 |   |                             |
 |   |                             |
 |   +-----------------------------+
 |
 +----------------------->  +U

 UV coordinate system

```

```
Blender coordinate system

                  +Z

                   X
                   X
                   X
                   X
                   X
                   X
                   X
                   X
                   X
                   X
                   XXXXXXXXXXXXXXXXXXXXXXXXX
                 XX                          +Y
               XXX
              XX
             XX
           XXX
          XX
        XXX
       XX
      XX
      X

+X

```


```
                                       +                             ^
Expand direction        +-->           |            <--+             |
                                       v                             +

                   +---------+    +---------+    +---------+    +---------+
                   |         |    |         |    |         |    |         |
                   |         |    |         |    |    ^    |    |    ^    |
Freedom block      |         |    |         |    |    |    |    |    |    |
                   |    +--> |    | <--+    |    | <--+    |    |    +--> |
                   |    |    |    |    |    |    |         |    |         |
                   |    v    |    |    v    |    |         |    |         |
                   |         |    |         |    |         |    |         |
                   +---------+    +---------+    +---------+    +---------+

                   +---------+    +---------+    +---------+    +---------+
                   |         |    |         |    |         |    |         |
                   |         |    |         |    |         |    |    ^    |
                   |         |    |         |    |         |    |    |    |
Column block       |    +--> |    |    +    |    | <--+    |    |    +    |
                   |         |    |    |    |    |         |    |         |
                   |         |    |    v    |    |         |    |         |
                   |         |    |         |    |         |    |         |
                   +---------+    +---------+    +---------+    +---------+

```

### 单位

* 贴图边框的条纹宽16像素（换算成UV为0.125）
* 下沉路面下沉0.7单位，对应的贴图减少到0.86（减少0.14）

### 网格

#### 可编程坐标

BMERevenge使用可编程坐标来使得模型可以按照用户需要的大小，在尽可能减少多边形数量的情况下进行构建。  
可编程坐标在底层使用Python的`eval`函数进行计算。但在计算前会使用`ast`模块进行必要检查以限制其执行非法代码。因此在可编程坐标中只能使用有限的运算符，如下表所示：

* `()`：括号，强制结合。
* `+-*/`：四则运算，优先级与数学一致。
* 立即数：即显式指定的浮点数或整数。
* 有限的只读变量：由使用场景决定的有限的只读变量的引用。通常是`d1`，`d2`，`d3`这三个。有时候则没有`d3`。

#### 顶点

原型的网格的每个顶点的三维坐标格式：`x, y, z`  
`xyz`分别都是一个可编程坐标。  
`,`是分割字符，字符串中的空格在计算时会被忽略，因此可以随意书写。 

在顶点的可编程坐标中，可用的三个变量参数为`d1`，`d2`，`d3`。其含义分别如下。

* `d1` 主延伸方向，实际参数的数值为：`d1 = D1 * unit`
* `d2` 次延伸方向，实际参数的数值为：`d2 = D2 * unit`
* `d3` 高度延伸方向，实际参数的数值为：`d3 = (height - 1) * 5.0`

其中`unit`由当前块的类型决定，如果是`Small`则为`2.5`，否则则为`5.0`。  
高度的`5.0`则因为方块默认高度总为5，不受方块类型限制。  
`D1`，`D2`是用户输入的延伸参数（整数），在这里通过这样的运算转换为3D世界中的真实延伸长度（raw expand）  
`(height - 1)`则确保将用户输入的高度数值（零至正无穷）；在小于1时，使得`d3`代表的是相对于`5.0`高度缩回去的数值（负数）；在大于1时，使`d3`代表的是多出`5.0`的长度的大小（正数）。

一些示例：
* `1,1,1`
* `1.0,1.0,1.0`
* `1.0 + d1, 1.0, 1.2`
* `1.0 + d3, 2 + d2, 3.3 -d1`

#### 顶点UV

原型的网格的每个顶点的顶点UV坐标格式：`u, v`  
`uv`分别都是一个可编程坐标。  

在UV的可编程坐标中，可用的三个变量参数为`d1`，`d2`，`d3`。其含义分别如下。

* `d1` 主延伸方向，实际参数的数值为：`d1 = D1 * unit`
* `d2` 次延伸方向，实际参数的数值为：`d2 = D2 * unit`
* `d3` 高度延伸方向，实际参数的数值为：`d3 = (height - 1) * 1.0`

其中`unit`由当前块的类型决定，如果是`Small`则为`0.5`，否则则为`1.0`。

一些示例：
* `0.2, 0.2`
* `0.2 + d2, 0.1`
* `0.2 + d1, 0.1`
* `0.2 - d3, 0.1 + d2`

### 构建

#### Vanilla block

一个物体的构建遵循如下过程：

将起始方块的中心当作坐标原点开始构建，因为默认是以左上角为原点的，因此需要根据方块大小平移一定位置（小块1.25，大块2.5来达到上述要求）

然后读取延伸规定，按默认延伸方向延伸。

然后读取旋转参数，对模型中的每一个三维坐标乘以旋转矩阵，达到旋转目的，之后再平移到正确的起始方块位置。

#### Derived block

拆分成Vanilla block然后构建。

### Smashed vanilla blocks

#### StartPosition

表述方块的起始位置的坐标格式：`x, y, z`。均为可编程坐标。

在此可编程坐标中，可用的三个变量参数为`d1`，`d2`，`d3`。其含义分别如下。

* `d1` 主延伸方向，实际参数的数值为：`d1 = D1 * unit`
* `d2` 次延伸方向，实际参数的数值为：`d2 = D2 * unit`
* `d3` 高度延伸方向，实际参数的数值为：`d3 = (height - 1) * 5.0`

其中`unit`由当前块（是Derived Block，不是当前的Smashed vanilla blocks）的类型决定，如果是`Small`则为`2.5`，否则则为`5.0`。 

一些示例：
* `0, 0, 0.0`
* `d1, d2, -0.7`

#### ExpandParam

表述方块的延伸参数格式：`sub_d1, sub_d2`。均为可编程坐标。

在此可编程坐标中，可用的三个变量参数为`d1`，`d2`。其含义分别如下。

* `d1` 主延伸方向，实际参数的数值为：`d1 = D1`
* `d2` 次延伸方向，实际参数的数值为：`d2 = D2`

即当前参数的`d1`，`d2`完整地表示了用户针对Derived Block的延伸参数设定，用于计算子块的延伸参数。  
同时，本可编程坐标额外要求**仅允许整数运算**，浮点数运算是非法的。因此计算出的结果才是整数并可用于Smashed vanilla blocks的延伸参数。

一些示例：
* `0, 0`
* `d1, d2`
* `1 + d1, 2 + d2`

#### SideSync

指定Derived block中Smashed vanilla block的边同步属性，遵循如下格式`2dTop;2dRight;2dBottom;2dLeft;3dTop;3dBottom`

其中每一项可以是下面列表中的任意一项，分隔符分号不可省略，不可留空：

直接指定是否要这个面：

* `True`
* `False`

与主方块同步属性：

* `2dTop`
* `2dRight`
* `2dBottom`
* `2dLeft`
* `3dTop`
* `3dBottom`

示例：

* `True;False;2dLeft;3dTop;3dTop;3dBottom`
* `True;True;True;True;True;True`

### 杂项

* Derived block中的unit大小指的是判断起始坐标偏移Unit是按大方块还是小方块方式偏移
* Vanilla block和Basic block是一个东西，只是因为前后改名的缘故导致不一致
* Derived block或者Vanilla block的延伸长度并不一定指代其最终长度是`length * unit`。例如Derived block - NormalPlatform，其具有一个最小大小，延伸为0时其为最小状态（3 x Small unit的正方形），延伸指的是它在最小状态向外延伸的长度
* 设计上，方块的有边缘纹路的边侧才需要使用FloorSide，其余的边（即正常不应该有的边侧）应当使用全白的材质（就是那个无边框路面材质）
* Faces中的Type指定了面的类型，RECTANGLE为四边形，TRIANGLE为三角形
* 因为模型里的顶点可以共享，但顶点上的UV不行，所以UV是单独在每一个面中用UVs描述的，三角形就有3个UV，四边形就有4个UV
* 方块的Mesh内的旋转并不是简单的按照原点转，而是会读取放块（basic block）的大小，如果是Small，则按2.5x2.5的中心旋转，否则按5x5的中心旋转。旋转后再应用偏移等操作。