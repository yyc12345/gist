# 开发帮助

BMERevenge开发中需要遵守的一些规定

## Prototype

### 坐标系

* 坐标系系统使用Blender的右手坐标系
* UV系统使用右手坐标系，具体参考后图
* 原型中使用右手坐标系，输出BM文件的时候需要按标准转换成左手坐标系（BM使用左手坐标系），具体是：三角形逆序，交换Vector3的YZ分量，UV分量中的V加负号。
* 三角形顶点序使用右手定则确定正面指向（OpenGL默认用右手坐标系，默认用右手定则确认正面；DirectX默认用左手坐标系，默认用左手定则确认正面）
* 各个面的定义按方块左上角顶面位置为原点，以3D坐标系定义（不要使用Screen坐标系）
* 每种方块具有延伸方向的属性，对于Column模式的方块，其延伸方向即为延伸方向指定的方向，而对于Freedom模式的方块，由于是可以沿着两个方向进行延伸，则规定延伸方向指定的方向为第一延伸方向，第二延伸方向在第一方向顺时针旋转后的下一个方向


```
         Image coordinate system

         +-----------> Image +X
         |
         |  +-------------------------------------------+
         |  |                                           |
         |  | Image                                     |
         |  |                                           |
Image +Y v  |                                           |
            |                                           |
            |                                           |
            |                                           |
            |                                           |
            |                                           |
            |                                           |
            |                                           |
            |                                           |
      +V ^  |                                           |
         |  |                                           |
         |  |                                           |
         |  |                                           |
         |  |                                           |
         |  |                                           |
         |  +-------------------------------------------+
         |
         +-----------> +U

         UV coordinate system

```

```
Blender coordinate system

                  +Z

                   X
                   X
                   X
                   X
                   X
                   X
                   X
                   X
                   X
                   X
                   XXXXXXXXXXXXXXXXXXXXXXXXX
                 XX                          +Y
               XXX
              XX
             XX
           XXX
          XX
        XXX
       XX
      XX
      X

+X

```

```
                                          3D +Y

                                          Screen +X

          +----------------------------------->
          |
          | +----------------------------------------------------------------+
          | |                                                                |
          | |  Canvas                                                        |
          | |                                                                |
          | |                                                                |
          | |                                                                |
          | |                                                                |
          | |                                                                |
          | |                                                                |
          | |                                                                |
          | |                                                                |
          | |                                                                |
3D +X     | |                                                                |
          v |                                                                |
Screen +Y   |                                                                |
            |                                                                |
            |                                                                |
            |                                                                |
            |                                                                |
            |                                                                |
            |                                                                |
            |                                                                |
            |                                                                |
            |                                                                |
            +----------------------------------------------------------------+

```

```
                                       +                             ^
Expand direction        +-->           |            <--+             |
                                       v                             +

                   +---------+    +---------+    +---------+    +---------+
                   |         |    |         |    |         |    |         |
                   |         |    |         |    |    ^    |    |    ^    |
Freedom block      |         |    |         |    |    |    |    |    |    |
                   |    +--> |    | <--+    |    | <--+    |    |    +--> |
                   |    |    |    |    |    |    |         |    |         |
                   |    v    |    |    v    |    |         |    |         |
                   |         |    |         |    |         |    |         |
                   +---------+    +---------+    +---------+    +---------+

                   +---------+    +---------+    +---------+    +---------+
                   |         |    |         |    |         |    |         |
                   |         |    |         |    |         |    |    ^    |
                   |         |    |         |    |         |    |    |    |
Column block       |    +--> |    |    +    |    | <--+    |    |    +    |
                   |         |    |    |    |    |         |    |         |
                   |         |    |    v    |    |         |    |         |
                   |         |    |         |    |         |    |         |
                   +---------+    +---------+    +---------+    +---------+

```

### 单位

* 贴图边框的条纹宽16像素（换算成UV为0.125）
* 下沉路面下沉0.7单位

### 网格

#### 顶点

原型的网格的每个顶点的三维坐标格式：`x,y,z;offset`

其中`xyz`表示坐标，为浮点或整数（整数当作浮点处理）

`offset`可以由下列字符前后紧密拼接而成，每个字符表述当前坐标是否受某个轴的延伸所影响，并指定延伸方向。如果`offset`不存在，分号可以省略

* `+x`
* `-x`
* `+y`
* `-y`
* `+z`
* `-z`

一些示例：
* `1,1,1`
* `1.0,1.0,1.0`
* `1.0,1.0,1.2;+x`
* `1.0,2,3.3;+z-y-z`


#### 顶点UV

原型的网格的每个顶点的顶点UV坐标格式：`u,v;u_offset;v_offset`

其中`uv`表示坐标，为浮点或整数（整数当作浮点处理）

`u_offset`和`v_offset`可以由下列字符中的任何一个填写，每个字符表述对应的坐标份量是否受某个轴的延伸所影响，并指定延伸方向。在任何情况下，分号都不可以省略

* `+x`
* `-x`
* `+y`
* `-y`
* `+z`
* `-z`

一些示例：
* `0.2,0.2;;`
* `0.2,0.1;;+y`
* `0.2,0.1;+x;`
* `0.2,0.1;-z;+y`

#### 比较与解释

显而易见，一个顶点会受到当前Block的延生属性影响，进而影响其顶点分布，由于采用3D坐标，因而不需要指定延生轴作用于哪个分量，因为延生轴只可能作用于对应分量。

而对于UV，UV坐标系与3D坐标系没有任何内在关联，因此需要分别指定这些UV分量受哪些延生轴影响，又因为其只可能受一个延生轴影响，因此只允许指定一个延生轴向。

这就是上述格式如此设计的原因

### 构建

#### Vanilla block

一个物体的构建遵循如下过程：

将起始方块的中心当作坐标原点开始构建，因为默认是以左上角为原点的，因此需要根据方块大小平移一定位置（小块1.25，大块2.5来达到上述要求）

然后读取延伸规定，按默认延伸方向延伸。

然后读取旋转参数，对模型中的每一个三维坐标乘以旋转矩阵，达到旋转目的，之后再平移到正确的起始方块位置。

#### Derived block

拆分成Vanilla block然后构建。

### Smashed vanilla blocks

#### StartPosition & ExpandPosition

表述方块的起始和延伸位置的二维坐标格式：`x,y;xSyncReduce,xSync,ySyncReduce,ySync`

其中`xy`表示坐标，为非负整数，分号和逗号不可以省略

`SyncReduce`，正整数，表示当后续同步设置时，会将同步选项所同步的长度减去此指定数值。如果不存在，默认为0。

`Sync`可以由下列字符其中之一，表述当前指定方向与主方块的哪个延伸方向进行同步。如果`Sync`不存在，表述不同步。

* `+d1` 同步主延伸方向正向
* `-d1` 同步主延伸方向反向
* `+d2` 同步次延伸方向正向
* `-d2` 同步次延伸方向反向

一些示例：
* `0,0;,,,`
* `0,0;,+d1,+d2`
* `1,1;2,+d1,2,+d2`

#### SideSync

指定Derived block中Smashed vanilla block的边同步属性，遵循如下格式`2dTop;2dRight;2dBottom;2dLeft;3dTop;3dBottom`

其中每一项可以是下面列表中的任意一项，分隔符分号不可省略，不可留空：

直接指定是否要这个面：

* `True`
* `False`

与主方块同步属性：

* `2dTop`
* `2dRight`
* `2dBottom`
* `2dLeft`
* `3dTop`
* `3dBottom`

示例：

* `True;False;2dLeft;3dTop;3dTop;3dBottom`
* `True;True;True;True;True;True`